using ClubMembership.Models;
using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Linq;
using System.Net;
using System.Web.Mvc;
using PagedList;

namespace ClubMembership.Controllers
{
    public class MemberShipMasterController : Controller
    {
        private readonly ApplicationDbContext _db;

        public MemberShipMasterController()
        {
            _db = new ApplicationDbContext();
        }

        // GET: MemberShipMaster
        public ActionResult Index(int? page)
        {
            int pageSize = 10;
            int pageNumber = (page ?? 1);
            var members = _db.MemberShipMasters.OrderBy(m => m.Member_Name).ToPagedList(pageNumber, pageSize);
            return View(members);
        }

        // GET: MemberShipMaster/Create
        public ActionResult Create()
        {
            var viewModel = new MemberProfileViewModel();
            return View(viewModel);
        }

        // POST: MemberShipMaster/Create
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Create(MemberProfileViewModel viewModel)
        {
            if (ModelState.IsValid)
            {
                _db.MemberShipMasters.Add(viewModel.Member);
                _db.SaveChanges();
                // Save children
                if (viewModel.Children != null)
                {
                    foreach (var child in viewModel.Children)
                    {
                        child.MemberID = viewModel.Member.MemberID;
                        _db.MemberShipFamilyDetails.Add(child);
                    }
                }
                // Save org details
                if (viewModel.OrganizationDetails != null)
                {
                    foreach (var org in viewModel.OrganizationDetails)
                    {
                        org.MemberID = viewModel.Member.MemberID;
                        _db.MemberShipODetails.Add(org);
                    }
                }
                _db.SaveChanges();
                return RedirectToAction("Index");
            }
            return View(viewModel);
        }

        // GET: MemberShipMaster/Edit/5
        public ActionResult Edit(int? id)
        {
            if (id == null) return new HttpStatusCodeResult(HttpStatusCode.BadRequest);
            var member = _db.MemberShipMasters.Find(id);
            if (member == null) return HttpNotFound();
            var viewModel = new MemberProfileViewModel
            {
                Member = member,
                Children = _db.MemberShipFamilyDetails.Where(f => f.MemberID == member.MemberID).ToList(),
                OrganizationDetails = _db.MemberShipODetails.Where(o => o.MemberID == member.MemberID).ToList()
            };
            return View(viewModel);
        }

        // POST: MemberShipMaster/Edit/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Edit(MemberProfileViewModel viewModel)
        {
            if (ModelState.IsValid)
            {
                _db.Entry(viewModel.Member).State = EntityState.Modified;
                // Remove old children/orgs
                var oldChildren = _db.MemberShipFamilyDetails.Where(f => f.MemberID == viewModel.Member.MemberID);
                _db.MemberShipFamilyDetails.RemoveRange(oldChildren);
                var oldOrgs = _db.MemberShipODetails.Where(o => o.MemberID == viewModel.Member.MemberID);
                _db.MemberShipODetails.RemoveRange(oldOrgs);
                _db.SaveChanges();
                // Add new children/orgs
                if (viewModel.Children != null)
                {
                    foreach (var child in viewModel.Children)
                    {
                        child.MemberID = viewModel.Member.MemberID;
                        _db.MemberShipFamilyDetails.Add(child);
                    }
                }
                if (viewModel.OrganizationDetails != null)
                {
                    foreach (var org in viewModel.OrganizationDetails)
                    {
                        org.MemberID = viewModel.Member.MemberID;
                        _db.MemberShipODetails.Add(org);
                    }
                }
                _db.SaveChanges();
                return RedirectToAction("Index");
            }
            return View(viewModel);
        }

        // GET: MemberShipMaster/Delete/5
        public ActionResult Delete(int? id)
        {
            if (id == null) return new HttpStatusCodeResult(HttpStatusCode.BadRequest);
            var member = _db.MemberShipMasters.Find(id);
            if (member == null) return HttpNotFound();
            return View(member);
        }

        // POST: MemberShipMaster/Delete/5
        [HttpPost, ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public ActionResult DeleteConfirmed(int id)
        {
            var member = _db.MemberShipMasters.Find(id);
            if (member != null)
            {
                // Remove children/orgs
                var children = _db.MemberShipFamilyDetails.Where(f => f.MemberID == member.MemberID);
                _db.MemberShipFamilyDetails.RemoveRange(children);
                var orgs = _db.MemberShipODetails.Where(o => o.MemberID == member.MemberID);
                _db.MemberShipODetails.RemoveRange(orgs);
                _db.MemberShipMasters.Remove(member);
                _db.SaveChanges();
            }
            return RedirectToAction("Index");
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                _db.Dispose();
            }
            base.Dispose(disposing);
        }
    }
}